import { ChannelInvitation } from '@/contexts/ChannelContext';

export interface NotificationServiceResponse {
    success: boolean;
    error?: string;
    data?: any;
}

export class NotificationService {
    /**
     * G·ª≠i notification qua Socket.io
     */
    static sendSocketNotification(socket: any, event: string, data: any): NotificationServiceResponse {
        try {
            if (!socket) {
                console.error('Socket is not available');
                return {
                    success: false,
                    error: 'Socket connection not available'
                };
            }

            console.log(`Sending ${event} notification:`, data);
            console.log('Socket ID:', socket.id);
            console.log('Socket connected:', socket.connected);

            socket.emit(event, data);

            console.log(`${event} notification sent successfully`);

            return {
                success: true
            };
        } catch (error) {
            console.error(`Error sending ${event} notification:`, error);
            return {
                success: false,
                error: error instanceof Error ? error.message : 'Unknown error'
            };
        }
    }

    /**
     * G·ª≠i channel invitation notification
     */
    static sendChannelInvitationNotification(socket: any, recipientId: string, invitation: ChannelInvitation): NotificationServiceResponse {
        return this.sendSocketNotification(socket, 'sendChannelInvitation', {
            recipientId,
            payload: invitation
        });
    }

    /**
     * G·ª≠i invitation accepted notification
     */
    static sendInvitationAcceptedNotification(socket: any, inviterId: string, invitation: ChannelInvitation): NotificationServiceResponse {
        return this.sendSocketNotification(socket, 'acceptChannelInvitation', {
            inviterId,
            payload: invitation
        });
    }

    /**
     * G·ª≠i invitation declined notification
     */
    static sendInvitationDeclinedNotification(socket: any, inviterId: string, invitation: ChannelInvitation): NotificationServiceResponse {
        return this.sendSocketNotification(socket, 'declineChannelInvitation', {
            inviterId,
            payload: invitation
        });
    }

    /**
     * G·ª≠i meeting notification
     */
    static sendMeetingNotification(socket: any, channelId: string, meetingData: any): NotificationServiceResponse {
        return this.sendSocketNotification(socket, 'notifyChannelMeeting', {
            channelId,
            meetingData
        });
    }

    /**
     * G·ª≠i channel message notification
     */
    static sendChannelMessageNotification(socket: any, channelId: string, message: any, senderId: string): NotificationServiceResponse {
        return this.sendSocketNotification(socket, 'sendChannelMessage', {
            channelId,
            message,
            senderId
        });
    }

    /**
     * Test socket connection
     */
    static testSocketConnection(socket: any, userId: string): NotificationServiceResponse {
        return this.sendSocketNotification(socket, 'testConnection', { userId });
    }

    /**
     * ƒêƒÉng k√Ω user v·ªõi socket
     */
    static registerUserWithSocket(socket: any, userId: string, userInfo: any): NotificationServiceResponse {
        try {
            if (!socket) {
                console.error('Socket is not available for user registration');
                return {
                    success: false,
                    error: 'Socket connection not available'
                };
            }

            console.log('Registering user with socket:', {
                userId,
                userInfo,
                socketId: socket.id,
                isConnected: socket.connected
            });

            // Emit userOnline event
            socket.emit('userOnline', {
                userId,
                userInfo
            });

            // Emit join event for call functionality
            socket.emit('join', userId);

            console.log('User registered with socket successfully');

            return {
                success: true
            };
        } catch (error) {
            console.error('Error registering user with socket:', error);
            return {
                success: false,
                error: error instanceof Error ? error.message : 'Unknown error'
            };
        }
    }

    /**
     * G·ª≠i poll vote notification
     */
    static sendPollVoteNotification(
        socket: any,
        channelId: string,
        pollId: string,
        optionId: string,
        voter: { id: string; name: string; avatar?: string },
        pollQuestion: string,
        optionText: string
    ): NotificationServiceResponse {
        console.log('üìä Sending poll vote notification for channel:', channelId);
        console.log('üó≥Ô∏è Vote data:', { pollId, optionId, voter, pollQuestion, optionText });

        return this.sendSocketNotification(socket, 'pollVoted', {
            channelId,
            pollId,
            optionId,
            voter,
            pollQuestion,
            optionText,
            timestamp: new Date()
        });
    }

    /**
     * G·ª≠i poll update (real-time sync poll data)
     */
    static sendPollUpdate(
        socket: any,
        channelId: string,
        messageId: string,
        updatedPoll: any
    ): NotificationServiceResponse {
        console.log('üìä [NotificationService] Sending poll update for channel:', channelId);
        console.log('üîÑ Poll ID being sent:', updatedPoll.id);
        console.log('üîÑ Poll question:', updatedPoll.question);
        console.log('üîÑ Total voters:', updatedPoll.totalVoters);
        console.log('üì° Socket connected:', socket?.connected);
        console.log('üì° Socket ID:', socket?.id);

        const payload = {
            channelId,
            messageId,
            updatedPoll,
            timestamp: new Date()
        };

        console.log('üì§ Full payload being sent:', payload);

        const result = this.sendSocketNotification(socket, 'pollUpdated', payload);

        if (result.success) {
            console.log('‚úÖ Poll update sent successfully for poll:', updatedPoll.id);
        } else {
            console.error('‚ùå Failed to send poll update:', result.error);
        }

        return result;
    }
} 